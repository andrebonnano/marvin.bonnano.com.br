name: Deploy marvin-site

on:
  push:
    branches:
      - desenv
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      # Se precisar de build (ex.: npm/yarn), adicionar aqui.
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Selecionar destino (dev ou prod)
        id: env
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" = "desenv" ]; then
            echo "path=/opt/projetos/marvin-site/dev" >> $GITHUB_OUTPUT
          else
            echo "path=/opt/projetos/marvin-site/prod" >> $GITHUB_OUTPUT
          fi

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan 46.202.146.95 >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy via rsync
        run: |
          rsync -avz --delete ./ bonnano@46.202.146.95:${{ steps.env.outputs.path }}/
